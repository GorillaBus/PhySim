<!DOCTYPE html>
<html>
<head>
    <title>Vector Class Demo</title>
    <link rel="stylesheet" type="text/css" href="demos.css" />
    <script>

    var player;
    
    // Browser compatibility hack
    var module = function() {
        this.exports = function() { };
    };

    window.onload = function() {
        var canvas = document.getElementById("canvas");
        var ctx = canvas.getContext("2d");
        var width = canvas.width = window.innerWidth-4;
        var height = canvas.height = window.innerHeight-4;

        // Ship movement & actions
        var angle = 0;
        var turningLeft = false;
        var turningRight = false;
        var thrusting = false;
        var firing = false;

        // Ship drawing
        var shipSettings = {
            x: width / 2,
            y: height / 2,
            friction: 0.99
        }
        var ship = Particle.create(shipSettings);
        var thrust = Vector.create({ x: 0, y: 0 });
        var bullets = [];
        var numBullets = 0;

        // Demo player
        player = AnimationPlayer.create();        
        player.setUpdateFn(update);
        player.play();


        // Frame drawing function
        function update(updateFn) {
            ctx.clearRect(0,0, width, height);            

            // Ship movement
            if (turningLeft) {
                angle -= 0.05;
            }

            if (turningRight) {
                angle += 0.05;
            }

            if (thrusting) {
                thrust.setAngle(angle);
                thrust.setLength(0.1);
            } else {
                thrust.setLength(0);
            }

            // Firing adds more bullets
            if (firing) {
                var bulletSettings = {
                    x: ship.position.getX(),
                    y: ship.position.getY(),
                    speed: 1,
                    direction: angle
                };

                var impulseSettings = {
                    x: ship.position.getX(),
                    y: ship.position.getY(),
                    length: 1,
                    angle: angle
                };

                var newBullet = {
                    bullet: Particle.create(bulletSettings),
                    impulse: Vector.create(impulseSettings)
                };

                // Add new bullet to the queue
                bullets.push(newBullet);
                numBullets = bullets.length;
            }

            // Update ship position
            ship.accelerate(thrust);
            ship.update();

            // Draw ship
            ctx.save();
            ctx.translate(ship.position.getX(), ship.position.getY());
            ctx.rotate(angle);
            ctx.beginPath();
            ctx.moveTo(10, 0);
            ctx.lineTo(-10, -7);
            ctx.lineTo(-10, 7);
            ctx.lineTo(10, 0);
            ctx.closePath();
            ctx.fillStyle = "#000000";
            ctx.fill();

            // Draw thrust
            if (thrusting) {
                ctx.beginPath();
                ctx.moveTo(-10, 0);
                ctx.lineTo(-18, 0);
                ctx.closePath();
                ctx.stroke();
            }
            ctx.restore();

            // Draw bullets
            if (numBullets > 0) {
                for (var i=0;i<numBullets;i++) {
                    var bullet = bullets[i].bullet;
                    var impulse = bullets[i].impulse;

                    // Destroy bullet when it goes out of the screen
                    if (bullet.position.getX() > width || bullet.position.getY() > height || bullet.position.getX() < 0 || bullet.position.getY() < 0) {
                        delete bullet; 
                        bullets.splice(i, 1);
                        numBullets--;
                        continue;
                    }  

                    // Update bullet
                    bullet.accelerate(impulse); 
                    bullet.update();

                    // Draw bullet
                    ctx.beginPath();
                    ctx.arc(bullet.position.getX(), bullet.position.getY(), 4, 0, Math.PI * 2, false);
                    ctx.fillStyle = "#FF0000";
                    ctx.fill();
                    ctx.closePath();
                    ctx.stroke();
                }
            }
            

            // Handle ship positioning when out of sight
            if (ship.position.getX() > width) {
                ship.position.setX(0);
            }
            if (ship.position.getY() > height) {
                ship.position.setY(0);
            }
            if (ship.position.getX() < 0) {
                ship.position.setX(width);
            }
            if (ship.position.getY() < 0) {
                ship.position.setY(height);
            }
        }







        // Animation control: KeyDown
        document.body.addEventListener("keydown", function(e) {
            //console.log("Key pressed: ", e.keyCode);
            switch (e.keyCode) {
                case 38:                        // Up
                    thrusting = true;
                    break;
                case 37:                        // Left
                    turningLeft = true;
                    break;
                case 39:                        // Right
                    turningRight = true;
                    break;
                case 27:                        // Esc
                    if (player.playing) {
                        player.stop();
                        console.log("> Scene stopped");
                    } else {
                        player.play();
                        console.log("> Playing scene");
                    }
                    break;
                default:
                    break;
            }
        });

        // Animation control: KeyUp
        document.body.addEventListener("keyup", function(e) {
            switch (e.keyCode) {
                case 38:                        // Up
                    thrusting = false;
                    break;
                case 37:                        // Left
                    turningLeft = false;
                    break;
                case 39:                        // Right
                    turningRight = false;
                    break;
                case 32:                        // Space
                    firing = true;
                    setTimeout(function() {
                        firing = false;
                    }, 20);
                    break;
                default:
                    break;
            }
        });
    };
    </script>

    <script src="../lib/Vector.js" type="text/javascript"></script>
    <script src="../lib/Particle.js" type="text/javascript"></script>
    <script src="../lib/AnimationPlayer.js" type="text/javascript"></script>
    </head>
<body>
<canvas id="canvas"></canvas>
</body>
</html>